<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MundoVerde - Sistema Simple</title>
    <meta name="theme-color" content="#2e7d32">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MundoVerde">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTXVuZG9WZXJkZSIsInNob3J0X25hbWUiOiJNdW5kb1ZlcmRlIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNlOGY1ZTkiLCJ0aGVtZV9jb2xvciI6IiMyZTdkMzIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3RleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCclM0UlRjAlOUYlOUElOUMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { color: #2e7d32; margin-bottom: 20px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        .stat-card.purple { background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%); }
        .stat-card.green { background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%); }
        .stat-value { font-size: 28px; font-weight: bold; margin: 5px 0; }
        .stat-detail { font-size: 11px; opacity: 0.85; margin-top: 8px; }
        .tabs {
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow-x: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tab-list { display: flex; border-bottom: 2px solid #e0e0e0; }
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }
        .tab.active {
            color: #2e7d32;
            border-bottom: 3px solid #2e7d32;
            background: #e8f5e9;
        }
        .content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        label { font-size: 13px; font-weight: 600; margin-bottom: 5px; }
        input, select, textarea {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-success { background: #388e3c; color: white; }
        .btn-success:hover { background: #2e7d32; }
        .btn-danger { background: #d32f2f; color: white; padding: 8px 12px; font-size: 12px; }
        .btn-danger:hover { background: #c62828; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        th { background: #f5f5f5; font-weight: 600; }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin-bottom: 15px;
        }
        .btn-export {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 0 5px;
        }
        .btn-export:hover {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .btn-import {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 0 5px;
        }
        .btn-import:hover {
            background: linear-gradient(135deg, #0d47a1 0%, #01579b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .btn-import:active {
            transform: translateY(0);
        }
        .btn-export:active {
            transform: translateY(0);
        }
        .excel-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-radius: 10px;
        }
        .excel-buttons button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .excel-buttons button:active {
            transform: translateY(0);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöú MundoVerde - Sistema PRO</h1>
            
            <div class="stats">
                <div class="stat-card purple">
                    <div>üë®‚Äçüåæ EMMA - Saldo pendiente</div>
                    <div class="stat-value" id="stat-emma">$0</div>
                    <div class="stat-detail">
                        <div>Pagado: <span id="stat-emma-pagado">$0</span></div>
                        <div id="stat-emma-detalle"></div>
                    </div>
                </div>
                <div class="stat-card blue">
                    <div>üë®‚Äçüåæ PABLO - Saldo pendiente</div>
                    <div class="stat-value" id="stat-pablo">$0</div>
                    <div class="stat-detail">
                        <div>Pagado: <span id="stat-pablo-pagado">$0</span></div>
                        <div id="stat-pablo-detalle"></div>
                    </div>
                </div>
                <div class="stat-card green">
                    <div>Balance Emma-Pablo</div>
                    <div class="stat-value" id="stat-balance">Equilibrado ‚úÖ</div>
                </div>
                <div class="excel-buttons">
                    <button class="btn-export" onclick="exportarATodo()" title="Exportar todo a Excel con formato">
                        üì• Exportar Excel
                    </button>
                    <button class="btn-import" onclick="importarDesdeExcel()" title="Importar datos desde Excel">
                        üì§ Importar Excel
                    </button>
                </div>

            </div>
        </div>

        <div class="tabs">
            <div class="tab-list" id="tabs">
                <button class="tab active" data-tab="trabajo">üìù Registro Trabajo</button>
                <button class="tab" data-tab="pagos">üí≥ Pagos Tractoristas</button>
                <button class="tab" data-tab="resumen-general">üìä Resumen General</button>
                <button class="tab" data-tab="gastos">üí∞ Gastos</button>
                <button class="tab" data-tab="balance">‚öñÔ∏è Balance Emma-Pablo</button>
                <button class="tab" data-tab="dashboard">üìà Dashboard</button>
                <button class="tab" data-tab="config">‚öôÔ∏è Lotes & Config</button>
            </div>
        </div>

        <div class="content">
            <div id="tab-content"></div>
        </div>
    </div>

    <script>
        
        // ===== CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyB7MLGd9NPYR41yXmUPBF24w1wqgVptzVo",
            authDomain: "mundo-verde-f881a.firebaseapp.com",
            projectId: "mundo-verde-f881a",
            storageBucket: "mundo-verde-f881a.firebasestorage.app",
            messagingSenderId: "342483025850",
            appId: "1:342483025850:web:d2a27fb39975fcb6306783"
        };
        
        // Inicializar Firebase
        let db = null;
        let firebaseIniciado = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseIniciado = true;
            console.log('‚úÖ Firebase conectado');
        } catch (error) {
            console.log('‚ö†Ô∏è Firebase no disponible, usando solo localStorage');
            firebaseIniciado = false;
        }
        
        // Funci√≥n para sincronizar con Firebase
        async function sincronizarConFirebase() {
            if (!firebaseIniciado || !db) return;
            
            try {
                const timestamp = new Date().toISOString();
                ultimoCambioLocal = timestamp; // Marcar que este cambio es local
                
                const docRef = db.collection('mundoverde').doc('datos');
                await docRef.set({
                    trabajos: estado.trabajos,
                    pagosTractoristas: estado.pagosTractoristas,
                    gastosGenerales: estado.gastosGenerales,
                    pagosEntreEmmaYPablo: estado.pagosEntreEmmaYPablo,
                    lotes: estado.lotes,
                    tractoristas: estado.tractoristas,
                    actividades: estado.actividades,
                    ultimaActualizacion: timestamp
                }, { merge: true });
                
                console.log('‚úÖ Datos sincronizados con Firebase');
            } catch (error) {
                console.error('Error al sincronizar:', error);
            }
        }
        
        // Funci√≥n para cargar desde Firebase
        async function cargarDesdeFirebase() {
            if (!firebaseIniciado || !db) return false;
            
            try {
                const docRef = db.collection('mundoverde').doc('datos');
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const datos = doc.data();
                    
                    // Solo actualizar si hay datos en Firebase
                    if (datos.trabajos) estado.trabajos = datos.trabajos;
                    if (datos.pagosTractoristas) estado.pagosTractoristas = datos.pagosTractoristas;
                    if (datos.gastosGenerales) estado.gastosGenerales = datos.gastosGenerales;
                    if (datos.pagosEntreEmmaYPablo) estado.pagosEntreEmmaYPablo = datos.pagosEntreEmmaYPablo;
                    if (datos.lotes) estado.lotes = datos.lotes;
                    if (datos.tractoristas) estado.tractoristas = datos.tractoristas;
                    if (datos.actividades) estado.actividades = datos.actividades;
                    
                    console.log('‚úÖ Datos cargados desde Firebase');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error al cargar desde Firebase:', error);
                return false;
            }
        }
        
        // Escuchar cambios en tiempo real
        // Variable para trackear si este tab hizo el √∫ltimo cambio
        let ultimoCambioLocal = null;
        
        function escucharCambiosFirebase() {
            if (!firebaseIniciado || !db) return;
            
            db.collection('mundoverde').doc('datos').onSnapshot((doc) => {
                if (doc.exists) {
                    const datos = doc.data();
                    
                    // Si este cambio fue hecho por este tab, no actualizar
                    if (datos.ultimaActualizacion === ultimoCambioLocal) {
                        console.log('üìù Cambio hecho por esta pesta√±a, ignorando');
                        return;
                    }
                    
                    // Actualizar con los datos de Firebase
                    if (datos.trabajos) estado.trabajos = datos.trabajos;
                    if (datos.pagosTractoristas) estado.pagosTractoristas = datos.pagosTractoristas;
                    if (datos.gastosGenerales) estado.gastosGenerales = datos.gastosGenerales;
                    if (datos.pagosEntreEmmaYPablo) estado.pagosEntreEmmaYPablo = datos.pagosEntreEmmaYPablo;
                    if (datos.lotes) estado.lotes = datos.lotes;
                    if (datos.tractoristas) estado.tractoristas = datos.tractoristas;
                    if (datos.actividades) estado.actividades = datos.actividades;
                    
                    localStorage.setItem('mundoverde_ultima_actualizacion', datos.ultimaActualizacion);
                    guardarEnLocalStorage();
                    renderizar();
                    console.log('üîÑ Datos actualizados desde otro dispositivo/pesta√±a');
                }
            });
        }
let estado = {
            tractoristas: ['Juan', 'Carlos', 'Miguel'],
            actividades: [
                { nombre: 'Volteo', precio: 15000 },
                { nombre: 'Rastrillado', precio: 12000 },
                { nombre: 'Rollos', precio: 3000 },
                { nombre: 'Otra actividad', precio: 0 }
            ],
            lotes: [
                { id: 1, nombre: 'Lote Norte', largo: 500, ancho: 400 }
            ],
            trabajos: [],
            pagosTractoristas: [],
            gastosGenerales: [],
            pagosEntreEmmaYPablo: []
        };

        let tabActual = 'trabajo';

        function guardar() {
            guardarEnLocalStorage();
            sincronizarConFirebase();
        }
        
        function guardarEnLocalStorage() {
            localStorage.setItem('mundoverde_trabajos', JSON.stringify(estado.trabajos));
            localStorage.setItem('mundoverde_pagos', JSON.stringify(estado.pagosTractoristas));
            localStorage.setItem('mundoverde_gastos', JSON.stringify(estado.gastosGenerales));
            localStorage.setItem('mundoverde_balance', JSON.stringify(estado.pagosEntreEmmaYPablo));
            localStorage.setItem('mundoverde_lotes', JSON.stringify(estado.lotes));
            localStorage.setItem('mundoverde_tractoristas', JSON.stringify(estado.tractoristas));
            localStorage.setItem('mundoverde_ultima_actualizacion', new Date().toISOString());
        }

        async function cargar() {
            // Primero intentar cargar desde Firebase
            const cargadoDesdeFirebase = await cargarDesdeFirebase();
            
            // Si no hay datos en Firebase, cargar desde localStorage
            if (!cargadoDesdeFirebase) {
                const trabajos = localStorage.getItem('mundoverde_trabajos');
                const pagos = localStorage.getItem('mundoverde_pagos');
                const gastos = localStorage.getItem('mundoverde_gastos');
                const balance = localStorage.getItem('mundoverde_balance');
                const lotes = localStorage.getItem('mundoverde_lotes');
                const tractoristas = localStorage.getItem('mundoverde_tractoristas');
                
                if (trabajos) estado.trabajos = JSON.parse(trabajos);
                if (pagos) estado.pagosTractoristas = JSON.parse(pagos);
                if (gastos) estado.gastosGenerales = JSON.parse(gastos);
                if (balance) estado.pagosEntreEmmaYPablo = JSON.parse(balance);
                if (lotes) estado.lotes = JSON.parse(lotes);
                if (tractoristas) estado.tractoristas = JSON.parse(tractoristas);
                
                // Si hay datos en localStorage pero no en Firebase, sincronizar
                if (trabajos || pagos || gastos) {
                    sincronizarConFirebase();
                }
            } else {
                // Guardar en localStorage tambi√©n
                guardarEnLocalStorage();
            }
            
            // Iniciar escucha de cambios en tiempo real
            escucharCambiosFirebase();
        }

        function formatearNumero(num) {
            if (isNaN(num) || num === null || num === undefined) {
                return '0';
            }
            return num.toLocaleString('es-AR');
        }

        function formatearFecha(fecha) {
            const d = new Date(fecha + 'T00:00:00');
            return d.toLocaleDateString('es-AR');
        }

        function calcularHa(largo, ancho) {
            return ((largo * ancho) / 10000).toFixed(2);
        }

        function calcularTotales() {
            const total = estado.trabajos.reduce((s, t) => {
                const cantidad = isNaN(t.cantidad) ? 0 : t.cantidad;
                const precio = isNaN(t.precio) ? 0 : t.precio;
                // Para "Otra actividad", usar precio directamente sin multiplicar
                const monto = t.actividad === 'Otra actividad' ? precio : (cantidad * precio);
                return s + monto;
            }, 0);
            const emmaPagado = estado.pagosTractoristas.filter(p => p.pagador === 'Emma').reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            const pabloPagado = estado.pagosTractoristas.filter(p => p.pagador === 'Pablo').reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            
            return {
                total,
                emmaPagado,
                pabloPagado,
                emmaDebe: (total / 2) - emmaPagado,
                pabloDebe: (total / 2) - pabloPagado
            };
        }

        function calcularPorTractorista(nombre) {
            const trabajos = estado.trabajos.filter(t => t.tractorista === nombre);
            const trabajado = trabajos.reduce((s, t) => {
                const cantidad = isNaN(t.cantidad) ? 0 : t.cantidad;
                const precio = isNaN(t.precio) ? 0 : t.precio;
                // Para "Otra actividad", usar precio directamente sin multiplicar
                const monto = t.actividad === 'Otra actividad' ? precio : (cantidad * precio);
                return s + monto;
            }, 0);
            const pagos = estado.pagosTractoristas.filter(p => p.tractorista === nombre);
            const pagado = pagos.reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            const emmaPago = pagos.filter(p => p.pagador === 'Emma').reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            const pabloPago = pagos.filter(p => p.pagador === 'Pablo').reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            
            return {
                trabajado,
                pagado,
                pendiente: trabajado - pagado,
                emmaDebe: (trabajado / 2) - emmaPago,
                pabloDebe: (trabajado / 2) - pabloPago
            };
        }

        function actualizarStats() {
            const totales = calcularTotales();
            
            document.getElementById('stat-emma').textContent = '$' + formatearNumero(totales.emmaDebe);
            document.getElementById('stat-emma-pagado').textContent = '$' + formatearNumero(totales.emmaPagado);
            document.getElementById('stat-pablo').textContent = '$' + formatearNumero(totales.pabloDebe);
            document.getElementById('stat-pablo-pagado').textContent = '$' + formatearNumero(totales.pabloPagado);
            
            let detalleEmma = '';
            estado.tractoristas.forEach(t => {
                const info = calcularPorTractorista(t);
                if (info.emmaDebe > 0) {
                    detalleEmma += `‚Ä¢ ${t}: $${formatearNumero(info.emmaDebe)}<br>`;
                }
            });
            document.getElementById('stat-emma-detalle').innerHTML = detalleEmma || 'Sin deudas';
            
            let detallePablo = '';
            estado.tractoristas.forEach(t => {
                const info = calcularPorTractorista(t);
                if (info.pabloDebe > 0) {
                    detallePablo += `‚Ä¢ ${t}: $${formatearNumero(info.pabloDebe)}<br>`;
                }
            });
            document.getElementById('stat-pablo-detalle').innerHTML = detallePablo || 'Sin deudas';
        }

        function renderizar() {
            const contenedor = document.getElementById('tab-content');
            
            if (tabActual === 'trabajo') {
                contenedor.innerHTML = `
                    <h2>Registro de Trabajos</h2>
                    
                    <div class="card" style="background: #fff3e0; margin-bottom: 20px;">
                        <h3 style="color: #e65100;">Calculadora de Hect√°reas</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div class="form-group">
                                <label>Largo (metros)</label>
                                <input type="number" id="calc-largo" step="0.01" placeholder="Ej: 500">
                            </div>
                            <div class="form-group">
                                <label>Ancho (metros)</label>
                                <input type="number" id="calc-ancho" step="0.01" placeholder="Ej: 400">
                            </div>
                            <div id="calc-resultado" style="font-size: 18px; font-weight: bold; color: #2e7d32;"></div>
                            <button class="btn-success" onclick="calcularHectareas()">Calcular</button>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>Nuevo Trabajo</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="t-fecha" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Tractorista</label>
                                <select id="t-tractorista">
                                    ${estado.tractoristas.map(t => `<option>${t}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Lote</label>
                                <select id="t-lote">
                                    ${estado.lotes.map(l => `<option value="${l.id}">${l.nombre}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Actividad</label>
                                <select id="t-actividad" onchange="actualizarPrecioActividad()">
                                    ${estado.actividades.map(a => `<option>${a.nombre}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cantidad</label>
                                <input type="number" id="t-cantidad" step="0.01" required min="0.01">
                            </div>
                            <div class="form-group">
                                <label>Precio</label>
                                <input type="number" id="t-precio" step="0.01" value="${estado.actividades[0].precio}" required min="0">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Notas (opcional)</label>
                            <textarea id="t-notas" rows="2" placeholder="Agregar detalles o comentarios..."></textarea>
                        </div>
                        <button class="btn-success" onclick="agregarTrabajo()">‚ûï Registrar Trabajo</button>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tractorista</th>
                                <th>Lote</th>
                                <th>Actividad</th>
                                <th>Cantidad</th>
                                <th>Total</th>
                                <th>Notas</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estado.trabajos.map(t => `
                                <tr>
                                    <td>${formatearFecha(t.fecha)}</td>
                                    <td>${t.tractorista}</td>
                                    <td>${t.lote}</td>
                                    <td>${t.actividad}</td>
                                    <td>${t.actividad === 'Otra actividad' ? '-' : t.cantidad}</td>
                                    <td>$${formatearNumero(t.actividad === 'Otra actividad' ? t.precio : (t.cantidad * t.precio))}</td>
                                    <td style="font-size: 12px; color: #666;">${t.notas || '-'}</td>
                                    <td><button class="btn-danger btn-eliminar" data-tipo="trabajo" data-id="${t.id}">üóëÔ∏è</button></td>
                                </tr>
                            `).join('') || '<tr><td colspan="8" style="text-align:center;">No hay trabajos</td></tr>'}
                        </tbody>
                    </table>
                `;
            } else if (tabActual === 'config') {
                contenedor.innerHTML = `
                    <h2>Lotes & Configuraci√≥n</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>Lotes</h3>
                            <div class="form-section">
                                <h4>Agregar Lote</h4>
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" id="l-nombre">
                                </div>
                                <div class="form-group">
                                    <label>Largo (m)</label>
                                    <input type="number" id="l-largo" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Ancho (m)</label>
                                    <input type="number" id="l-ancho" step="0.01">
                                </div>
                                <button class="btn-success" onclick="agregarLote()">‚ûï Agregar</button>
                            </div>
                            
                            ${estado.lotes.map(l => `
                                <div class="card">
                                    <h4>${l.nombre}</h4>
                                    <p>üìè ${l.largo}m x ${l.ancho}m = ${calcularHa(l.largo, l.ancho)} ha</p>
                                    <button class="btn-danger btn-eliminar" data-tipo="lote" data-id="${l.id}">üóëÔ∏è Eliminar</button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <h3>Tractoristas</h3>
                            <div class="form-section">
                                <h4>Agregar Tractorista</h4>
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <input type="text" id="trac-nombre">
                                </div>
                                <button class="btn-success" onclick="agregarTractorista()">‚ûï Agregar</button>
                            </div>
                            
                            ${estado.tractoristas.map(t => `
                                <div class="card">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>${t}</span>
                                        <button class="btn-danger btn-eliminar" data-tipo="tractorista" data-nombre="${t}">üóëÔ∏è</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <h3>Precios Actividades</h3>
                            <div class="form-section">
                                <h4>Configurar Precios</h4>
                                ${estado.actividades.map((a, idx) => `
                                    <div class="card" style="background: #f5f5f5;">
                                        <div style="margin-bottom: 10px;">
                                            <strong>${a.nombre}</strong>
                                        </div>
                                        <div class="form-group">
                                            <label>Precio por ${a.nombre === 'Rollos' ? 'unidad' : 'hect√°rea'}</label>
                                            <input 
                                                type="number" 
                                                id="precio-${idx}" 
                                                value="${a.precio}" 
                                                step="0.01"
                                                onchange="actualizarPrecio(${idx}, this.value)"
                                            >
                                        </div>
                                        <div style="color: #2e7d32; font-weight: bold;">
                                            $${formatearNumero(a.precio)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabActual === 'pagos') {
                contenedor.innerHTML = `
                    <h2>Pagos a Tractoristas</h2>
                    
                    <div class="form-section">
                        <h3>Registrar Pago</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="p-fecha" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Tractorista</label>
                                <select id="p-tractorista">
                                    ${estado.tractoristas.map(t => `<option>${t}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quien paga</label>
                                <select id="p-pagador">
                                    <option>Emma</option>
                                    <option>Pablo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Monto</label>
                                <input type="number" id="p-monto" step="0.01" required min="0.01">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Concepto (opcional)</label>
                            <textarea id="p-concepto" rows="2" placeholder="Detalle del pago..."></textarea>
                        </div>
                        <button class="btn-success" onclick="agregarPago()">üí∞ Registrar Pago</button>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Historial de Pagos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tractorista</th>
                                <th>Pagador</th>
                                <th>Monto</th>
                                <th>Concepto</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estado.pagosTractoristas.map(p => `
                                <tr>
                                    <td>${formatearFecha(p.fecha)}</td>
                                    <td>${p.tractorista}</td>
                                    <td><span style="color: ${p.pagador === 'Emma' ? '#ba68c8' : '#64b5f6'}; font-weight: bold;">${p.pagador}</span></td>
                                    <td><span style="color: ${p.pagador === 'Emma' ? '#64b5f6' : '#ba68c8'}; font-weight: bold;">${p.pagador === 'Emma' ? 'Pablo' : 'Emma'}</span></td>
                                    <td>$${formatearNumero(p.monto)}</td>
                                    <td style="font-size: 12px; color: #666;">${p.concepto || '-'}</td>
                                    <td><button class="btn-danger btn-eliminar" data-tipo="pago" data-id="${p.id}">üóëÔ∏è</button></td>
                                </tr>
                            `).join('') || '<tr><td colspan="6" style="text-align:center;">No hay pagos registrados</td></tr>'}
                        </tbody>
                    </table>
                `;
            } else if (tabActual === 'resumen-general') {
                const totales = calcularTotales();
                const resumen = calcularResumenGeneral();
                
                contenedor.innerHTML = `
                    <h2 style="color: #2e7d32; margin-bottom: 25px;">Resumen de Pagos (50/50)</h2>
                    
                    <!-- ARRIBA: Cards Emma y Pablo -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
                        <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 30px; border-radius: 15px; border: 2px solid #ba68c8;">
                            <h3 style="color: #6a1b9a; margin-bottom: 20px; font-size: 24px;">üë®‚Äçüåæ EMMA</h3>
                            <div style="margin-bottom: 15px;">
                                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Total a pagar (50%)</div>
                                <div style="font-size: 32px; font-weight: bold; color: #6a1b9a;">$${formatearNumero(totales.total / 2)}</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Ya pagado</div>
                                <div style="font-size: 24px; font-weight: bold; color: #4caf50;">- $${formatearNumero(totales.emmaPagado)}</div>
                            </div>
                            <hr style="border: none; border-top: 2px solid #ba68c8; margin: 20px 0;">
                            <div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Saldo pendiente</div>
                                <div style="font-size: 36px; font-weight: bold; color: ${totales.emmaDebe > 0 ? '#d32f2f' : '#4caf50'};">$${formatearNumero(totales.emmaDebe)}</div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 30px; border-radius: 15px; border: 2px solid #64b5f6;">
                            <h3 style="color: #1565c0; margin-bottom: 20px; font-size: 24px;">üë®‚Äçüåæ PABLO</h3>
                            <div style="margin-bottom: 15px;">
                                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Total a pagar (50%)</div>
                                <div style="font-size: 32px; font-weight: bold; color: #1565c0;">$${formatearNumero(totales.total / 2)}</div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Ya pagado</div>
                                <div style="font-size: 24px; font-weight: bold; color: #4caf50;">- $${formatearNumero(totales.pabloPagado)}</div>
                            </div>
                            <hr style="border: none; border-top: 2px solid #64b5f6; margin: 20px 0;">
                            <div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Saldo pendiente</div>
                                <div style="font-size: 36px; font-weight: bold; color: ${totales.pabloDebe > 0 ? '#d32f2f' : '#4caf50'};">$${formatearNumero(totales.pabloDebe)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- MEDIO: Detalle por tractorista -->
                    <h2 style="color: #2e7d32; margin-bottom: 25px; margin-top: 40px;">Detalle por Tractorista</h2>
                    
                    ${estado.tractoristas.map(tractorista => {
                        const info = calcularPorTractorista(tractorista);
                        const trabajosDelTractorista = estado.trabajos.filter(t => t.tractorista === tractorista);
                        
                        return `
                            <div style="background: #e3f2fd; padding: 25px; border-radius: 15px; margin-bottom: 25px;">
                                <h3 style="color: #1565c0; margin-bottom: 20px; font-size: 22px;">${tractorista}</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 25px; text-align: center;">
                                    <div>
                                        <div style="color: #666; font-size: 13px; margin-bottom: 5px;">Trabajado</div>
                                        <div style="font-size: 28px; font-weight: bold; color: #1565c0;">$${formatearNumero(info.trabajado)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 13px; margin-bottom: 5px;">Pagado</div>
                                        <div style="font-size: 28px; font-weight: bold; color: #4caf50;">$${formatearNumero(info.pagado)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #666; font-size: 13px; margin-bottom: 5px;">Pendiente</div>
                                        <div style="font-size: 28px; font-weight: bold; color: ${info.pendiente > 0 ? '#f44336' : (info.pendiente < 0 ? '#ff9800' : '#4caf50')};">$${formatearNumero(info.pendiente)}</div>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 20px; border-radius: 10px;">
                                    <h4 style="margin-bottom: 15px; color: #333;">Trabajos realizados:</h4>
                                    ${trabajosDelTractorista.length > 0 ? trabajosDelTractorista.map(t => {
                                        const monto = t.actividad === 'Otra actividad' ? t.precio : (t.cantidad * t.precio);
                                        return `
                                            <div style="padding: 10px 0; border-bottom: 1px solid #e0e0e0;">
                                                ${formatearFecha(t.fecha)} - ${t.lote} - ${t.actividad} - ${t.actividad === 'Otra actividad' ? '-' : t.cantidad + (t.actividad === 'Rollos' ? ' rollos' : ' ha')} = $${formatearNumero(monto)}
                                            </div>
                                        `;
                                    }).join('') : '<div style="color: #999; padding: 10px 0;">Sin trabajos registrados</div>'}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <!-- ABAJO: Totales generales -->
                    <h2 style="color: #2e7d32; margin-bottom: 25px; margin-top: 40px;">Totales Generales</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Hect√°reas Trabajadas</div>
                            <div style="font-size: 36px; font-weight: bold;">${resumen.totalHectareas}</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Rollos Realizados</div>
                            <div style="font-size: 36px; font-weight: bold;">${resumen.totalRollos}</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ba68c8 0%, #ab47bc 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Trabajado</div>
                            <div style="font-size: 36px; font-weight: bold;">$${formatearNumero(resumen.totalDinero)}</div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #4db6ac 0%, #26a69a 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">Total Pagado</div>
                            <div style="font-size: 36px; font-weight: bold;">$${formatearNumero(resumen.totalPagado)}</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px;">Detalle por Actividad</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Actividad</th>
                                <th>Cantidad</th>
                                <th>Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(resumen.porActividad).map(([actividad, datos]) => `
                                <tr>
                                    <td><strong>${actividad}</strong></td>
                                    <td>${actividad === 'Otra actividad' ? '-' : datos.cantidad}</td>
                                    <td>$${formatearNumero(datos.monto)}</td>
                                </tr>
                            `).join('')}
                            <tr style="background: #f5f5f5; font-weight: bold;">
                                <td>TOTAL</td>
                                <td>-</td>
                                <td>$${formatearNumero(resumen.totalDinero)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else if (tabActual === 'gastos') {
                const totalGastos = estado.gastosGenerales.reduce((s, g) => s + (isNaN(g.monto) ? 0 : g.monto), 0);
                contenedor.innerHTML = `
                    <h2>Gastos Generales</h2>
                    
                    <div class="form-section">
                        <h3>Registrar Gasto</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="g-fecha" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Concepto</label>
                                <input type="text" id="g-concepto" placeholder="Ej: Combustible, Repuestos...">
                            </div>
                            <div class="form-group">
                                <label>Quien paga</label>
                                <select id="g-pagador">
                                    <option>Emma</option>
                                    <option>Pablo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Monto</label>
                                <input type="number" id="g-monto" step="0.01" required min="0.01">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Detalle (opcional)</label>
                            <textarea id="g-detalle" rows="2" placeholder="Descripci√≥n del gasto..."></textarea>
                        </div>
                        <button class="btn-success" onclick="agregarGasto()">üí∏ Registrar Gasto</button>
                    </div>
                    
                    <div class="card" style="background: #ffebee; margin: 20px 0;">
                        <h3 style="color: #c62828;">üí∞ Total Gastos: $${formatearNumero(totalGastos)}</h3>
                    </div>
                    
                    <h3>Historial de Gastos</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Concepto</th>
                                <th>Pagador</th>
                                <th>Monto</th>
                                <th>Detalle</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estado.gastosGenerales.map(g => `
                                <tr>
                                    <td>${formatearFecha(g.fecha)}</td>
                                    <td><strong>${g.concepto}</strong></td>
                                    <td><span style="color: ${g.pagador === 'Emma' ? '#ba68c8' : '#64b5f6'}; font-weight: bold;">${g.pagador}</span></td>
                                    <td>$${formatearNumero(g.monto)}</td>
                                    <td style="font-size: 12px; color: #666;">${g.detalle || '-'}</td>
                                    <td><button class="btn-danger btn-eliminar" data-tipo="gasto" data-id="${g.id}">üóëÔ∏è</button></td>
                                </tr>
                            `).join('') || '<tr><td colspan="6" style="text-align:center;">No hay gastos registrados</td></tr>'}
                        </tbody>
                    </table>
                `;
            } else if (tabActual === 'balance') {
                const balanceCompleto = calcularBalanceCompleto();
                contenedor.innerHTML = `
                    <h2>Balance Emma-Pablo</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="card" style="background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%); color: white;">
                            <h3>üë© EMMA</h3>
                            <div style="margin: 20px 0;">
                                <div style="margin-bottom: 10px;">Pag√≥ a tractoristas: <strong>$${formatearNumero(balanceCompleto.emma.pagosTractoristas)}</strong></div>
                                <div style="margin-bottom: 10px;">Gastos generales: <strong>$${formatearNumero(balanceCompleto.emma.gastos)}</strong></div>
                                <div style="margin-bottom: 10px;">Debe pagar: <strong>$${formatearNumero(balanceCompleto.emma.debePagar)}</strong></div>
                                <hr style="margin: 15px 0; border-color: rgba(255,255,255,0.3);">
                                <div style="font-size: 20px;"><strong>Total gastado: $${formatearNumero(balanceCompleto.emma.totalGastado)}</strong></div>
                            </div>
                        </div>
                        
                        <div class="card" style="background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%); color: white;">
                            <h3>üë® PABLO</h3>
                            <div style="margin: 20px 0;">
                                <div style="margin-bottom: 10px;">Pag√≥ a tractoristas: <strong>$${formatearNumero(balanceCompleto.pablo.pagosTractoristas)}</strong></div>
                                <div style="margin-bottom: 10px;">Gastos generales: <strong>$${formatearNumero(balanceCompleto.pablo.gastos)}</strong></div>
                                <div style="margin-bottom: 10px;">Debe pagar: <strong>$${formatearNumero(balanceCompleto.pablo.debePagar)}</strong></div>
                                <hr style="margin: 15px 0; border-color: rgba(255,255,255,0.3);">
                                <div style="font-size: 20px;"><strong>Total gastado: $${formatearNumero(balanceCompleto.pablo.totalGastado)}</strong></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="background: ${balanceCompleto.diferencia === 0 ? '#e8f5e9' : '#fff3e0'}; border: 2px solid ${balanceCompleto.diferencia === 0 ? '#4caf50' : '#ff9800'};">
                        <h3 style="color: ${balanceCompleto.diferencia === 0 ? '#2e7d32' : '#e65100'};">
                            ‚öñÔ∏è Estado del Balance
                        </h3>
                        <div style="font-size: 24px; margin: 15px 0;">
                            ${balanceCompleto.diferencia === 0 ? '‚úÖ Est√°n equilibrados' : 
                              balanceCompleto.diferencia > 0 ? 
                              `üë®‚Äçüåæ Pablo debe pagarle a Emma: <strong>$${formatearNumero(balanceCompleto.montoParaEquilibrar)}</strong>` :
                              `üë®‚Äçüåæ Emma debe pagarle a Pablo: <strong>$${formatearNumero(balanceCompleto.montoParaEquilibrar)}</strong>`
                            }
                        </div>
                    </div>
                    
                    <div class="form-section" style="margin-top: 30px;">
                        <h3>Registrar Pago entre Emma y Pablo</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha</label>
                                <input type="date" id="b-fecha" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="form-group">
                                <label>Quien paga</label>
                                <select id="b-pagador">
                                    <option>Emma</option>
                                    <option>Pablo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Monto</label>
                                <input type="number" id="b-monto" step="0.01" required min="0.01">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Concepto (opcional)</label>
                            <textarea id="b-concepto" rows="2" placeholder="Detalle del pago..."></textarea>
                        </div>
                        <button class="btn-success" onclick="agregarPagoBalance()">üí∞ Registrar Pago</button>
                    </div>
                    
                    <h3 style="margin-top: 30px;">Historial de Pagos Emma-Pablo</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Quien pag√≥</th>
                                <th>A quien</th>
                                <th>Monto</th>
                                <th>Concepto</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estado.pagosEntreEmmaYPablo.map(p => `
                                <tr>
                                    <td>${formatearFecha(p.fecha)}</td>
                                    <td><span style="color: ${p.pagador === 'Emma' ? '#ba68c8' : '#64b5f6'}; font-weight: bold;">${p.pagador}</span></td>
                                    <td><span style="color: ${p.pagador === 'Emma' ? '#64b5f6' : '#ba68c8'}; font-weight: bold;">${p.pagador === 'Emma' ? 'Pablo' : 'Emma'}</span></td>
                                    <td>$${formatearNumero(p.monto)}</td>
                                    <td style="font-size: 12px; color: #666;">${p.concepto || '-'}</td>
                                    <td><button class="btn-danger btn-eliminar" data-tipo="pago-balance" data-id="${p.id}">üóëÔ∏è</button></td>
                                </tr>
                            `).join('') || '<tr><td colspan="6" style="text-align:center;">No hay pagos registrados</td></tr>'}
                        </tbody>
                    </table>
                `;
            } else if (tabActual === 'dashboard') {
                const resumen = calcularResumenGeneral();
                const totales = calcularTotales();
                contenedor.innerHTML = `
                    <h2>Dashboard General</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div class="card" style="background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%); color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9;">Tractoristas</div>
                            <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${estado.tractoristas.length}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%); color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9;">Trabajos</div>
                            <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${estado.trabajos.length}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #ba68c8 0%, #ab47bc 100%); color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9;">Hect√°reas</div>
                            <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${resumen.totalHectareas}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #4db6ac 0%, #26a69a 100%); color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9;">Rollos</div>
                            <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${resumen.totalRollos}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #ff8a65 0%, #ff7043 100%); color: white; text-align: center;">
                            <div style="font-size: 14px; opacity: 0.9;">Lotes</div>
                            <div style="font-size: 42px; font-weight: bold; margin: 10px 0;">${estado.lotes.length}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="card">
                            <h3>Trabajos por Tractorista</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tractorista</th>
                                        <th>Trabajos</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${estado.tractoristas.map(t => {
                                        const info = calcularPorTractorista(t);
                                        const cantTrabajos = estado.trabajos.filter(tr => tr.tractorista === t).length;
                                        return `
                                            <tr>
                                                <td><strong>${t}</strong></td>
                                                <td>${cantTrabajos}</td>
                                                <td>$${formatearNumero(info.trabajado)}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card">
                            <h3>Actividades Realizadas</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Actividad</th>
                                        <th>Cantidad</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(resumen.porActividad).map(([actividad, datos]) => `
                                        <tr>
                                            <td><strong>${actividad}</strong></td>
                                            <td>${actividad === 'Otra actividad' ? '-' : datos.cantidad}</td>
                                            <td>$${formatearNumero(datos.monto)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>√öltimos 10 Trabajos</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tractorista</th>
                                    <th>Actividad</th>
                                    <th>Lote</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${estado.trabajos.slice(-10).reverse().map(t => `
                                    <tr>
                                        <td>${formatearFecha(t.fecha)}</td>
                                        <td>${t.tractorista}</td>
                                        <td>${t.actividad}</td>
                                        <td>${t.lote}</td>
                                        <td>$${formatearNumero(t.actividad === 'Otra actividad' ? t.precio : (t.cantidad * t.precio))}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="5" style="text-align:center;">No hay trabajos</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                contenedor.innerHTML = '<h2>Pesta√±a en desarrollo...</h2>';
            }
            
            actualizarStats();
            
            // Agregar event listeners a botones de eliminar
            setTimeout(() => {
                document.querySelectorAll('.btn-eliminar').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tipo = this.getAttribute('data-tipo');
                        const id = this.getAttribute('data-id');
                        const nombre = this.getAttribute('data-nombre');
                        
                        switch(tipo) {
                            case 'trabajo':
                                eliminarTrabajo(parseInt(id));
                                break;
                            case 'pago':
                                eliminarPago(parseInt(id));
                                break;
                            case 'gasto':
                                eliminarGasto(parseInt(id));
                                break;
                            case 'pago-balance':
                                eliminarPagoBalance(parseInt(id));
                                break;
                            case 'lote':
                                eliminarLote(parseInt(id));
                                break;
                            case 'tractorista':
                                eliminarTractorista(nombre);
                                break;
                        }
                    });
                });
            }, 100);
            
            // Agregar handlers para Enter en formularios
            if (tabActual === 'trabajo') {
                const inputs = document.querySelectorAll('#t-fecha, #t-tractorista, #t-lote, #t-actividad, #t-cantidad, #t-precio, #t-notas');
                inputs.forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            agregarTrabajo();
                        }
                    });
                });
            } else if (tabActual === 'pagos') {
                const inputs = document.querySelectorAll('#p-fecha, #p-tractorista, #p-pagador, #p-monto, #p-concepto');
                inputs.forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            agregarPago();
                        }
                    });
                });
            } else if (tabActual === 'gastos') {
                const inputs = document.querySelectorAll('#g-fecha, #g-concepto, #g-pagador, #g-monto, #g-detalle');
                inputs.forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            agregarGasto();
                        }
                    });
                });
            } else if (tabActual === 'balance') {
                const inputs = document.querySelectorAll('#b-fecha, #b-pagador, #b-monto, #b-concepto');
                inputs.forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            agregarPagoBalance();
                        }
                    });
                });
            } else if (tabActual === 'config') {
                const loteInputs = document.querySelectorAll('#l-nombre, #l-largo, #l-ancho');
                loteInputs.forEach(input => {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            agregarLote();
                        }
                    });
                });
                
                const tracInput = document.getElementById('trac-nombre');
                if (tracInput) {
                    tracInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            agregarTractorista();
                        }
                    });
                }
            }
        }

        function agregarTrabajo() {
            const loteId = parseInt(document.getElementById('t-lote').value);
            const lote = estado.lotes.find(l => l.id === loteId);
            
            // Validar inputs
            const cantidad = parseFloat(document.getElementById('t-cantidad').value);
            const precio = parseFloat(document.getElementById('t-precio').value);
            
            if (isNaN(cantidad) || cantidad <= 0) {
                alert('‚ö†Ô∏è Por favor ingrese una cantidad v√°lida');
                return;
            }
            
            if (isNaN(precio) || precio < 0) {
                alert('‚ö†Ô∏è Por favor ingrese un precio v√°lido');
                return;
            }
            
            const trabajo = {
                id: Date.now(),
                fecha: document.getElementById('t-fecha').value,
                tractorista: document.getElementById('t-tractorista').value,
                lote: lote.nombre,
                actividad: document.getElementById('t-actividad').value,
                cantidad: cantidad,
                precio: precio,
                notas: document.getElementById('t-notas').value.trim()
            };
            
            estado.trabajos.push(trabajo);
            guardar();
            
            // Limpiar el campo de notas despu√©s de guardar
            document.getElementById('t-notas').value = '';
            
            renderizar();
            // Trabajo registrado
        }

        function eliminarTrabajo(id) {
            if (confirm('¬øEliminar?')) {
                estado.trabajos = estado.trabajos.filter(t => t.id !== id);
                guardar();
                renderizar();
            }
        }

        function agregarLote() {
            const lote = {
                id: Date.now(),
                nombre: document.getElementById('l-nombre').value,
                largo: parseFloat(document.getElementById('l-largo').value),
                ancho: parseFloat(document.getElementById('l-ancho').value)
            };
            
            estado.lotes.push(lote);
            guardar();
            renderizar();
            // Lote agregado
        }

        function eliminarLote(id) {
            if (confirm('¬øEliminar lote?')) {
                estado.lotes = estado.lotes.filter(l => l.id !== id);
                guardar();
                renderizar();
            }
        }

        function agregarTractorista() {
            const nombre = document.getElementById('trac-nombre').value.trim();
            if (nombre && !estado.tractoristas.includes(nombre)) {
                estado.tractoristas.push(nombre);
                guardar();
                renderizar();
                // Tractorista agregado
            }
        }

        function eliminarTractorista(nombre) {
            if (confirm('¬øEliminar tractorista?')) {
                estado.tractoristas = estado.tractoristas.filter(t => t !== nombre);
                guardar();
                renderizar();
            }
        }

        function actualizarPrecio(idx, precio) {
            estado.actividades[idx].precio = parseFloat(precio) || 0;
            guardar();
            renderizar();
        }

        function actualizarPrecioActividad() {
            const actividad = document.getElementById('t-actividad').value;
            const cantidadInput = document.getElementById('t-cantidad');
            const precioInput = document.getElementById('t-precio');
            const act = estado.actividades.find(a => a.nombre === actividad);
            
            if (actividad === 'Otra actividad') {
                // Para "Otra actividad": cantidad siempre 1 y deshabilitada
                cantidadInput.value = 1;
                cantidadInput.disabled = true;
                precioInput.value = 0;
                precioInput.placeholder = 'Ingrese el monto total';
            } else {
                // Para otras actividades: habilitar cantidad y usar precio normal
                cantidadInput.disabled = false;
                cantidadInput.placeholder = '';
                if (act) {
                    precioInput.value = act.precio;
                }
            }
        }

        function calcularHectareas() {
            const largo = parseFloat(document.getElementById('calc-largo').value);
            const ancho = parseFloat(document.getElementById('calc-ancho').value);
            
            if (largo && ancho) {
                const ha = calcularHa(largo, ancho);
                document.getElementById('calc-resultado').innerHTML = `üåæ ${ha} hect√°reas`;
            } else {
                document.getElementById('calc-resultado').innerHTML = '‚ö†Ô∏è Ingrese valores';
            }
        }

        // ===== FUNCIONES PARA PAGOS A TRACTORISTAS =====
        function agregarPago() {
            const monto = parseFloat(document.getElementById('p-monto').value);
            
            if (isNaN(monto) || monto <= 0) {
                alert('‚ö†Ô∏è Por favor ingrese un monto v√°lido');
                return;
            }
            
            const pago = {
                id: Date.now(),
                fecha: document.getElementById('p-fecha').value,
                tractorista: document.getElementById('p-tractorista').value,
                pagador: document.getElementById('p-pagador').value,
                monto: monto,
                concepto: document.getElementById('p-concepto').value.trim()
            };
            
            estado.pagosTractoristas.push(pago);
            guardar();
            document.getElementById('p-concepto').value = '';
            renderizar();
            // Pago registrado
        }

        function eliminarPago(id) {
            if (confirm('¬øEliminar pago?')) {
                estado.pagosTractoristas = estado.pagosTractoristas.filter(p => p.id !== id);
                guardar();
                renderizar();
            }
        }

        // ===== FUNCIONES PARA RESUMEN =====
        function calcularResumenGeneral() {
            const porActividad = {};
            let totalHectareas = 0;
            let totalRollos = 0;
            let totalDinero = 0;
            
            // Inicializar actividades
            estado.actividades.forEach(act => {
                porActividad[act.nombre] = { cantidad: 0, monto: 0 };
            });
            
            // Calcular por trabajo
            estado.trabajos.forEach(t => {
                const cantidad = isNaN(t.cantidad) ? 0 : t.cantidad;
                const precio = isNaN(t.precio) ? 0 : t.precio;
                const monto = t.actividad === 'Otra actividad' ? precio : (cantidad * precio);
                
                if (!porActividad[t.actividad]) {
                    porActividad[t.actividad] = { cantidad: 0, monto: 0 };
                }
                
                // Solo sumar cantidades si NO es "Otra actividad"
                if (t.actividad !== 'Otra actividad') {
                    porActividad[t.actividad].cantidad += cantidad;
                    
                    // Sumar hect√°reas solo para actividades que no sean Rollos
                    if (t.actividad !== 'Rollos') {
                        totalHectareas += cantidad;
                    }
                    
                    // Sumar rollos solo para la actividad Rollos
                    if (t.actividad === 'Rollos') {
                        totalRollos += cantidad;
                    }
                }
                
                porActividad[t.actividad].monto += monto;
                totalDinero += monto;
            });
            
            const totales = calcularTotales();
            
            return {
                porActividad,
                totalHectareas: totalHectareas.toFixed(2),
                totalRollos: Math.round(totalRollos),
                totalDinero,
                totalPagado: totales.emmaPagado + totales.pabloPagado
            };
        }

        // ===== FUNCIONES PARA GASTOS =====
        function agregarGasto() {
            const monto = parseFloat(document.getElementById('g-monto').value);
            const concepto = document.getElementById('g-concepto').value.trim();
            
            if (!concepto) {
                alert('‚ö†Ô∏è Por favor ingrese un concepto');
                return;
            }
            
            if (isNaN(monto) || monto <= 0) {
                alert('‚ö†Ô∏è Por favor ingrese un monto v√°lido');
                return;
            }
            
            const gasto = {
                id: Date.now(),
                fecha: document.getElementById('g-fecha').value,
                concepto: concepto,
                pagador: document.getElementById('g-pagador').value,
                monto: monto,
                detalle: document.getElementById('g-detalle').value.trim()
            };
            
            estado.gastosGenerales.push(gasto);
            guardar();
            document.getElementById('g-concepto').value = '';
            document.getElementById('g-detalle').value = '';
            document.getElementById('g-monto').value = '';
            renderizar();
            // Gasto registrado
        }

        function eliminarGasto(id) {
            if (confirm('¬øEliminar gasto?')) {
                estado.gastosGenerales = estado.gastosGenerales.filter(g => g.id !== id);
                guardar();
                renderizar();
            }
        }

        // ===== FUNCIONES PARA BALANCE EMMA-PABLO =====
        function calcularBalanceCompleto() {
            const totales = calcularTotales();
            
            // Calcular gastos generales
            const gastosEmma = estado.gastosGenerales.filter(g => g.pagador === 'Emma').reduce((s, g) => s + (isNaN(g.monto) ? 0 : g.monto), 0);
            const gastosPablo = estado.gastosGenerales.filter(g => g.pagador === 'Pablo').reduce((s, g) => s + (isNaN(g.monto) ? 0 : g.monto), 0);
            
            // Calcular pagos entre Emma y Pablo
            const pagosEmmaAPablo = estado.pagosEntreEmmaYPablo.filter(p => p.pagador === 'Emma').reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            const pagosPabloAEmma = estado.pagosEntreEmmaYPablo.filter(p => p.pagador === 'Pablo').reduce((s, p) => s + (isNaN(p.monto) ? 0 : p.monto), 0);
            
            // Total que gast√≥ cada uno (sin contar pagos entre ellos)
            const totalGastadoEmma = totales.emmaPagado + gastosEmma;
            const totalGastadoPablo = totales.pabloPagado + gastosPablo;
            
            // Diferencia de gastos
            const diferenciaGastos = totalGastadoEmma - totalGastadoPablo;
            
            // Monto que uno debe pagarle al otro para equilibrar 50/50
            // Si positivo: Pablo debe a Emma
            // Si negativo: Emma debe a Pablo
            const debeEquilibrar = diferenciaGastos / 2;
            
            // Saldo neto de pagos entre ellos
            const saldoPagos = pagosPabloAEmma - pagosEmmaAPablo;
            
            // Diferencia final (cu√°nto falta para estar equilibrados)
            const diferenciaFinal = debeEquilibrar - saldoPagos;
            
            return {
                emma: {
                    pagosTractoristas: totales.emmaPagado,
                    gastos: gastosEmma,
                    debePagar: totales.emmaDebe,
                    totalGastado: totalGastadoEmma
                },
                pablo: {
                    pagosTractoristas: totales.pabloPagado,
                    gastos: gastosPablo,
                    debePagar: totales.pabloDebe,
                    totalGastado: totalGastadoPablo
                },
                diferencia: diferenciaFinal,
                montoParaEquilibrar: Math.abs(diferenciaFinal),
                pagosEmmaAPablo: pagosEmmaAPablo,
                pagosPabloAEmma: pagosPabloAEmma
            };
        }


        function agregarPagoBalance() {
            const monto = parseFloat(document.getElementById('b-monto').value);
            
            if (isNaN(monto) || monto <= 0) {
                alert('‚ö†Ô∏è Por favor ingrese un monto v√°lido');
                return;
            }
            
            const pago = {
                id: Date.now(),
                fecha: document.getElementById('b-fecha').value,
                pagador: document.getElementById('b-pagador').value,
                monto: monto,
                concepto: document.getElementById('b-concepto').value.trim()
            };
            
            estado.pagosEntreEmmaYPablo.push(pago);
            guardar();
            document.getElementById('b-concepto').value = '';
            document.getElementById('b-monto').value = '';
            renderizar();
            // Pago registrado
        }

        function eliminarPagoBalance(id) {
            if (confirm('¬øEliminar pago?')) {
                estado.pagosEntreEmmaYPablo = estado.pagosEntreEmmaYPablo.filter(p => p.id !== id);
                guardar();
                renderizar();
            }
        }



        // ===== FUNCI√ìN PARA EXPORTAR A EXCEL CON FORMATO =====
        async function exportarATodo() {
            if (!window.ExcelJS) {
                alert('Error: No se pudo cargar la librer√≠a de Excel. Por favor recarga la p√°gina.');
                return;
            }
            
            try {
                const workbook = new ExcelJS.Workbook();
                workbook.creator = 'MundoVerde';
                workbook.created = new Date();
                
                // Colores suaves (Opci√≥n B)
                const colores = {
                    trabajos: { fondo: '81C784', texto: 'FFFFFF' },
                    pagos: { fondo: '64B5F6', texto: 'FFFFFF' },
                    gastos: { fondo: 'FFB74D', texto: 'FFFFFF' },
                    balance: { fondo: 'BA68C8', texto: 'FFFFFF' },
                    resumen: { fondo: '90A4AE', texto: 'FFFFFF' },
                    cebra: 'F5F5F5',
                    total: 'FFF9C4'
                };
                
                // ===== HOJA 1: TRABAJOS =====
                const wsTrabajos = workbook.addWorksheet('Trabajos');
                
                // T√≠tulo
                wsTrabajos.mergeCells('A1:H1');
                const tituloTrabajos = wsTrabajos.getCell('A1');
                tituloTrabajos.value = 'TRABAJOS REGISTRADOS';
                tituloTrabajos.font = { size: 16, bold: true, color: { argb: colores.trabajos.texto } };
                tituloTrabajos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.trabajos.fondo } };
                tituloTrabajos.alignment = { vertical: 'middle', horizontal: 'center' };
                wsTrabajos.getRow(1).height = 30;
                
                // Encabezados
                wsTrabajos.addRow([]);
                const headerTrabajos = wsTrabajos.addRow(['Fecha', 'Tractorista', 'Lote', 'Actividad', 'Cantidad', 'Precio Unitario', 'Total', 'Notas']);
                headerTrabajos.font = { bold: true, color: { argb: colores.trabajos.texto } };
                headerTrabajos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.trabajos.fondo } };
                headerTrabajos.alignment = { vertical: 'middle', horizontal: 'center' };
                headerTrabajos.height = 25;
                
                // Datos
                let totalTrabajos = 0;
                estado.trabajos.forEach((t, i) => {
                    const cantidad = t.actividad === 'Otra actividad' ? '-' : t.cantidad;
                    const total = t.actividad === 'Otra actividad' ? t.precio : (t.cantidad * t.precio);
                    totalTrabajos += total;
                    
                    const row = wsTrabajos.addRow([
                        t.fecha,
                        t.tractorista,
                        t.lote,
                        t.actividad,
                        cantidad,
                        t.precio,
                        total,
                        t.notas || ''
                    ]);
                    
                    // Estilo cebra
                    if (i % 2 === 1) {
                        row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.cebra } };
                    }
                    
                    // Formato de moneda
                    row.getCell(6).numFmt = '"$"#,##0';
                    row.getCell(7).numFmt = '"$"#,##0';
                });
                
                // Total
                wsTrabajos.addRow([]);
                const totalRow = wsTrabajos.addRow(['', '', '', '', '', 'TOTAL:', totalTrabajos, '']);
                totalRow.font = { bold: true };
                totalRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.total } };
                totalRow.getCell(7).numFmt = '"$"#,##0';
                
                // Anchos de columna
                wsTrabajos.columns = [
                    { width: 12 }, { width: 20 }, { width: 15 }, { width: 20 },
                    { width: 10 }, { width: 15 }, { width: 15 }, { width: 30 }
                ];
                
                // ===== HOJA 2: PAGOS TRACTORISTAS =====
                const wsPagos = workbook.addWorksheet('Pagos Tractoristas');
                
                wsPagos.mergeCells('A1:E1');
                const tituloPagos = wsPagos.getCell('A1');
                tituloPagos.value = 'PAGOS A TRACTORISTAS';
                tituloPagos.font = { size: 16, bold: true, color: { argb: colores.pagos.texto } };
                tituloPagos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.pagos.fondo } };
                tituloPagos.alignment = { vertical: 'middle', horizontal: 'center' };
                wsPagos.getRow(1).height = 30;
                
                wsPagos.addRow([]);
                const headerPagos = wsPagos.addRow(['Fecha', 'Tractorista', 'Quien Pag√≥', 'Monto', 'Concepto']);
                headerPagos.font = { bold: true, color: { argb: colores.pagos.texto } };
                headerPagos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.pagos.fondo } };
                headerPagos.alignment = { vertical: 'middle', horizontal: 'center' };
                headerPagos.height = 25;
                
                let totalPagos = 0;
                estado.pagosTractoristas.forEach((p, i) => {
                    totalPagos += p.monto;
                    const row = wsPagos.addRow([p.fecha, p.tractorista, p.pagador, p.monto, p.concepto || '']);
                    
                    if (i % 2 === 1) {
                        row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.cebra } };
                    }
                    
                    row.getCell(4).numFmt = '"$"#,##0';
                });
                
                wsPagos.addRow([]);
                const totalRowPagos = wsPagos.addRow(['', '', 'TOTAL:', totalPagos, '']);
                totalRowPagos.font = { bold: true };
                totalRowPagos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.total } };
                totalRowPagos.getCell(4).numFmt = '"$"#,##0';
                
                wsPagos.columns = [
                    { width: 12 }, { width: 20 }, { width: 15 }, { width: 15 }, { width: 30 }
                ];
                
                // ===== HOJA 3: GASTOS GENERALES =====
                const wsGastos = workbook.addWorksheet('Gastos Generales');
                
                wsGastos.mergeCells('A1:E1');
                const tituloGastos = wsGastos.getCell('A1');
                tituloGastos.value = 'GASTOS GENERALES';
                tituloGastos.font = { size: 16, bold: true, color: { argb: colores.gastos.texto } };
                tituloGastos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.gastos.fondo } };
                tituloGastos.alignment = { vertical: 'middle', horizontal: 'center' };
                wsGastos.getRow(1).height = 30;
                
                wsGastos.addRow([]);
                const headerGastos = wsGastos.addRow(['Fecha', 'Concepto', 'Quien Pag√≥', 'Monto', 'Detalle']);
                headerGastos.font = { bold: true, color: { argb: colores.gastos.texto } };
                headerGastos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.gastos.fondo } };
                headerGastos.alignment = { vertical: 'middle', horizontal: 'center' };
                headerGastos.height = 25;
                
                let totalGastos = 0;
                estado.gastosGenerales.forEach((g, i) => {
                    totalGastos += g.monto;
                    const row = wsGastos.addRow([g.fecha, g.concepto, g.pagador, g.monto, g.detalle || '']);
                    
                    if (i % 2 === 1) {
                        row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.cebra } };
                    }
                    
                    row.getCell(4).numFmt = '"$"#,##0';
                });
                
                wsGastos.addRow([]);
                const totalRowGastos = wsGastos.addRow(['', '', 'TOTAL:', totalGastos, '']);
                totalRowGastos.font = { bold: true };
                totalRowGastos.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.total } };
                totalRowGastos.getCell(4).numFmt = '"$"#,##0';
                
                wsGastos.columns = [
                    { width: 12 }, { width: 25 }, { width: 15 }, { width: 15 }, { width: 30 }
                ];
                
                // ===== HOJA 4: BALANCE EMMA-PABLO =====
                const wsBalance = workbook.addWorksheet('Balance Emma-Pablo');
                
                wsBalance.mergeCells('A1:E1');
                const tituloBalance = wsBalance.getCell('A1');
                tituloBalance.value = 'PAGOS ENTRE EMMA Y PABLO';
                tituloBalance.font = { size: 16, bold: true, color: { argb: colores.balance.texto } };
                tituloBalance.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.balance.fondo } };
                tituloBalance.alignment = { vertical: 'middle', horizontal: 'center' };
                wsBalance.getRow(1).height = 30;
                
                wsBalance.addRow([]);
                const headerBalance = wsBalance.addRow(['Fecha', 'Quien Pag√≥', 'A Quien', 'Monto', 'Concepto']);
                headerBalance.font = { bold: true, color: { argb: colores.balance.texto } };
                headerBalance.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.balance.fondo } };
                headerBalance.alignment = { vertical: 'middle', horizontal: 'center' };
                headerBalance.height = 25;
                
                let totalBalance = 0;
                estado.pagosEntreEmmaYPablo.forEach((p, i) => {
                    const aQuien = p.pagador === 'Emma' ? 'Pablo' : 'Emma';
                    totalBalance += p.monto;
                    const row = wsBalance.addRow([p.fecha, p.pagador, aQuien, p.monto, p.concepto || '']);
                    
                    if (i % 2 === 1) {
                        row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.cebra } };
                    }
                    
                    row.getCell(4).numFmt = '"$"#,##0';
                });
                
                wsBalance.addRow([]);
                const totalRowBalance = wsBalance.addRow(['', '', 'TOTAL:', totalBalance, '']);
                totalRowBalance.font = { bold: true };
                totalRowBalance.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.total } };
                totalRowBalance.getCell(4).numFmt = '"$"#,##0';
                
                wsBalance.columns = [
                    { width: 12 }, { width: 15 }, { width: 15 }, { width: 15 }, { width: 30 }
                ];
                
                // ===== HOJA 5: RESUMEN =====
                const wsResumen = workbook.addWorksheet('Resumen');
                const totales = calcularTotales();
                const resumen = calcularResumenGeneral();
                const balanceCompleto = calcularBalanceCompleto();
                
                wsResumen.mergeCells('A1:B1');
                const tituloResumen = wsResumen.getCell('A1');
                tituloResumen.value = 'RESUMEN GENERAL MUNDOVERDE';
                tituloResumen.font = { size: 16, bold: true, color: { argb: colores.resumen.texto } };
                tituloResumen.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.resumen.fondo } };
                tituloResumen.alignment = { vertical: 'middle', horizontal: 'center' };
                wsResumen.getRow(1).height = 30;
                
                wsResumen.addRow([]);
                const headerResumen = wsResumen.addRow(['CONCEPTO', 'VALOR']);
                headerResumen.font = { bold: true, color: { argb: colores.resumen.texto } };
                headerResumen.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.resumen.fondo } };
                headerResumen.alignment = { vertical: 'middle', horizontal: 'center' };
                headerResumen.height = 25;
                
                const resumenData = [
                    [],
                    ['üìä TRABAJOS Y PAGOS', ''],
                    ['Total Trabajos Tractoristas', totales.total],
                    ['Total Pagado a Tractoristas', totales.emmaPagado + totales.pabloPagado],
                    ['Pendiente de Pagar', totales.total - (totales.emmaPagado + totales.pabloPagado)],
                    [],
                    ['üìè ESTAD√çSTICAS', ''],
                    ['Hect√°reas Trabajadas', resumen.totalHectareas],
                    ['Rollos Realizados', resumen.totalRollos],
                    ['Total Dinero (trabajos)', resumen.totalDinero],
                    [],
                    ['üë®‚Äçüåæ EMMA', ''],
                    ['  Pag√≥ a tractoristas', totales.emmaPagado],
                    ['  Gastos generales', balanceCompleto.emma.gastos],
                    ['  Total gastado', balanceCompleto.emma.totalGastado],
                    ['  Debe pagar a tractoristas', totales.emmaDebe],
                    [],
                    ['üë®‚Äçüåæ PABLO', ''],
                    ['  Pag√≥ a tractoristas', totales.pabloPagado],
                    ['  Gastos generales', balanceCompleto.pablo.gastos],
                    ['  Total gastado', balanceCompleto.pablo.totalGastado],
                    ['  Debe pagar a tractoristas', totales.pabloDebe],
                    [],
                    ['‚öñÔ∏è BALANCE EMMA-PABLO', ''],
                    ['  Diferencia', balanceCompleto.diferencia],
                    ['  Estado', balanceCompleto.diferencia === 0 ? 'Equilibrados' : 
                        balanceCompleto.diferencia > 0 ? 'Pablo debe a Emma' : 'Emma debe a Pablo'],
                    ['  Monto para equilibrar', balanceCompleto.montoParaEquilibrar],
                    [],
                    ['üìÖ FECHA DE EXPORTACI√ìN', new Date().toLocaleString('es-AR')]
                ];
                
                resumenData.forEach((row, i) => {
                    const excelRow = wsResumen.addRow(row);
                    
                    // Secciones en negrita
                    if (row[0] && (row[0].includes('üìä') || row[0].includes('üìè') || 
                        row[0].includes('üë®‚Äçüåæ') || row[0].includes('‚öñÔ∏è') || row[0].includes('üìÖ'))) {
                        excelRow.font = { bold: true };
                        excelRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colores.cebra } };
                    }
                    
                    // Formato de moneda
                    if (typeof row[1] === 'number') {
                        excelRow.getCell(2).numFmt = '"$"#,##0';
                    }
                });
                
                wsResumen.columns = [{ width: 35 }, { width: 20 }];
                
                // Generar y descargar
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `MundoVerde_${new Date().toISOString().split('T')[0]}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                console.log('‚úÖ Excel exportado con formato completo');
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('Error al exportar Excel. Verifica la consola para m√°s detalles.');
            }
        }
        
        // ===== FUNCI√ìN PARA IMPORTAR DESDE EXCEL =====
        async function importarDesdeExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);
                    
                    let cambios = 0;
                    
                    // IMPORTAR TRABAJOS
                    const wsTrabajos = workbook.getWorksheet('Trabajos');
                    if (wsTrabajos) {
                        const nuevosTrabajos = [];
                        wsTrabajos.eachRow((row, rowNumber) => {
                            if (rowNumber <= 3) return; // Saltar t√≠tulo y encabezados
                            
                            const values = row.values;
                            if (!values[1] || values[6] === 'TOTAL:') return;
                            
                            const trabajo = {
                                id: Date.now() + rowNumber,
                                fecha: values[1] || '',
                                tractorista: values[2] || '',
                                lote: values[3] || '',
                                actividad: values[4] || '',
                                cantidad: values[5] === '-' ? 0 : (parseFloat(values[5]) || 0),
                                precio: parseFloat(values[6]) || 0,
                                notas: values[8] || ''
                            };
                            nuevosTrabajos.push(trabajo);
                            cambios++;
                        });
                        if (nuevosTrabajos.length > 0) {
                            estado.trabajos = nuevosTrabajos;
                        }
                    }
                    
                    // IMPORTAR PAGOS
                    const wsPagos = workbook.getWorksheet('Pagos Tractoristas');
                    if (wsPagos) {
                        const nuevosPagos = [];
                        wsPagos.eachRow((row, rowNumber) => {
                            if (rowNumber <= 3) return;
                            
                            const values = row.values;
                            if (!values[1] || values[3] === 'TOTAL:') return;
                            
                            const pago = {
                                id: Date.now() + rowNumber,
                                fecha: values[1] || '',
                                tractorista: values[2] || '',
                                pagador: values[3] || 'Emma',
                                monto: parseFloat(values[4]) || 0,
                                concepto: values[5] || ''
                            };
                            nuevosPagos.push(pago);
                            cambios++;
                        });
                        if (nuevosPagos.length > 0) {
                            estado.pagosTractoristas = nuevosPagos;
                        }
                    }
                    
                    // IMPORTAR GASTOS
                    const wsGastos = workbook.getWorksheet('Gastos Generales');
                    if (wsGastos) {
                        const nuevosGastos = [];
                        wsGastos.eachRow((row, rowNumber) => {
                            if (rowNumber <= 3) return;
                            
                            const values = row.values;
                            if (!values[1] || values[3] === 'TOTAL:') return;
                            
                            const gasto = {
                                id: Date.now() + rowNumber,
                                fecha: values[1] || '',
                                concepto: values[2] || '',
                                pagador: values[3] || 'Emma',
                                monto: parseFloat(values[4]) || 0,
                                detalle: values[5] || ''
                            };
                            nuevosGastos.push(gasto);
                            cambios++;
                        });
                        if (nuevosGastos.length > 0) {
                            estado.gastosGenerales = nuevosGastos;
                        }
                    }
                    
                    // IMPORTAR BALANCE
                    const wsBalance = workbook.getWorksheet('Balance Emma-Pablo');
                    if (wsBalance) {
                        const nuevosBalance = [];
                        wsBalance.eachRow((row, rowNumber) => {
                            if (rowNumber <= 3) return;
                            
                            const values = row.values;
                            if (!values[1] || values[3] === 'TOTAL:') return;
                            
                            const balance = {
                                id: Date.now() + rowNumber,
                                fecha: values[1] || '',
                                pagador: values[2] || 'Emma',
                                monto: parseFloat(values[4]) || 0,
                                concepto: values[5] || ''
                            };
                            nuevosBalance.push(balance);
                            cambios++;
                        });
                        if (nuevosBalance.length > 0) {
                            estado.pagosEntreEmmaYPablo = nuevosBalance;
                        }
                    }
                    
                    guardar();
                    renderizar();
                    
                    alert(`‚úÖ Importaci√≥n exitosa!\n\n${cambios} registros importados.`);
                    
                } catch (error) {
                    console.error('Error al importar:', error);
                    alert('‚ùå Error al importar el archivo. Verifica que sea un Excel v√°lido exportado desde MundoVerde.');
                }
            };
            
            input.click();
        }


window.onload = function() {
            cargar();
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    tabActual = this.getAttribute('data-tab');
                    renderizar();
                });
            });
            
            renderizar();
        };
    </script>

    <script>
        // Registrar Service Worker para funcionamiento offline
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                const CACHE_NAME = 'mundoverde-v1';
                
                self.addEventListener('install', (event) => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then((cache) => {
                            return cache.addAll(['/']);
                        })
                    );
                });
                
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        caches.match(event.request).then((response) => {
                            return response || fetch(event.request);
                        })
                    );
                });
            `)).catch(err => {
                // Service Worker no disponible, continuar normalmente
                console.log('Service Worker no disponible');
            });
        }
    </script>



</body>
</html>
